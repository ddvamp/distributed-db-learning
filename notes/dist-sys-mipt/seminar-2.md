## Seminar 2. Реализация регистра в коде

Конфигурация системы постоянно меняется (отказы, обслуживание, расширение, проблемы сети), поэтому общаться с ней через конкретные адреса реплик неудобно (с некоторыми исключениями, см. Cassandra). Вместо этого клиент посылает запрос на какой-то узел, который выполняет операцию
В связи с этим у узлов две роли
- Coordinator - активная роль (алгоритмическая), методы (API) Set/Get: при запросе клиента инициирует работу с регистром как единым объектом (выбирает ts, собирает кворумы и т.д.)
- Replica - пасивная роль (структурная), методы (API) LocalRead/LocalWrite: при запросе координатора работает со своей копией регистра (сравнивает ts, обновляет значение, отвечает координатору и т.д.)
Для удобства координатор отправляет команду сам себе (loopback интерфейс). В коде правильно будет использовать для интерфейса (базовых класса - декомпозиция)
Удобно сделать роли отдельными серверами/сервисами и заменить Message Passing на Client-Server. В коде запросы к серверам осуществляются не через Callback-и, а через RPC - координатор общается с репликой будто она объект и вызывать его методы (именно так работают библиотечные клиенты на С++ различных распр. систем, client = KVStore(); client.Set(k, v)). Цель RPC - убрать из кода особенности сетевого взаимодействия, а также связать запрос и ответ

Клиент в своём коде выполняет RPC, на координатор приходит запрос, под который порождается файбер/корутина, который асинхронно дожидается сбора кворумов, первого и второго

Поскольку сеть ненадёжна (теряет сообщения), нужны Retry, которые нужно уметь останавливать, так что нужны cancellation, отправляемые по сбору кворума, по окончанию scope (RAII токен), по смерти корутины/файбера или по ручному завершению (stop token). Главное использовать таймауты (или иметь аналогичные механизмы отмены) в асинхронных системных вызовах, чтобы помимо ресурсов программы можно было освободить ресурсы ОС
Именно из-за retry-ев реплики посылают ack даже на запоздавшие записи, поскольку такое может случиться на большинстве узлов, и в противном случае таска бесконечно крутилась бы без возможности собрать кворум

<div>
  <a href=''>Left</a>
  <a href=''>Center</a>
  <a href=''>Right</a>
</div>
